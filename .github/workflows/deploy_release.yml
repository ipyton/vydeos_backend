name: Deploy Java Apps to Oracle Linux on release push
on:
  push:
    branches:
      - release
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ---------- Build Notification ----------
      - name: Build Notification
        working-directory: ./Notification
        run: mvn clean package -DskipTests

      # ---------- Upload Notification JAR ----------
      - name: Upload Notification JAR to Oracle Linux
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: 50022
          username: root
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "Notification/target/*.jar"
          target: "~/notification"
          strip_components: 2  # Remove Notification/target/ prefix
          timeout: 180s              # 3 minutes timeout
          command_timeout: 300s      # 5 minutes command timeout
          debug: true                # Enable debug mode
          overwrite: true            # Overwrite existing files

      # ---------- Restart Notification Service ----------
      - name: Restart Notification Java App
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          port: 50022 
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "========================================="
            echo "ğŸš€ NOTIFICATION SERVICE DEPLOYMENT START"
            echo "========================================="
            echo "ğŸ“… Deployment Time: $(date)"
            echo "ğŸ“‚ Working Directory: $(pwd)"
            
            cd ~/notification
            echo "ğŸ“ Current directory: $(pwd)"
            
            echo ""
            echo "ğŸ” STEP 1: Stopping existing Notification service..."
            echo "----------------------------------------"
            existing_pids=$(pgrep -f "java -jar .*$(pwd)" || true)
            if [ -n "$existing_pids" ]; then
              echo "Found existing processes: $existing_pids"
              echo "$existing_pids" | while read pid; do
                echo "ğŸ›‘ Stopping process $pid..."
                kill -15 "$pid" 2>/dev/null || kill -9 "$pid" 2>/dev/null
                sleep 2
                if kill -0 "$pid" 2>/dev/null; then
                  echo "âŒ Process $pid still running, force killing..."
                  kill -9 "$pid" 2>/dev/null || true
                else
                  echo "âœ… Process $pid stopped successfully"
                fi
              done
              echo "â³ Waiting 3 seconds for cleanup..."
              sleep 3
            else
              echo "â„¹ï¸  No existing Notification processes found"
            fi
            
            echo ""
            echo "ğŸ” STEP 2: Locating JAR files..."
            echo "----------------------------------------"
            echo "ğŸ“‹ Available JAR files:"
            ls -la *.jar 2>/dev/null || echo "âŒ No JAR files found"
            
            latest_jar=$(ls -t *.jar 2>/dev/null | head -n 1)
            if [ -z "$latest_jar" ]; then
              echo "âŒ ERROR: No JAR file found in $(pwd)"
              echo "ğŸ“‚ Directory contents:"
              ls -la
              exit 1
            fi
            
            echo "ğŸ¯ Selected JAR: $latest_jar"
            echo "ğŸ“Š JAR file info:"
            ls -lh "$latest_jar"
            
            echo ""
            echo "ğŸ” STEP 3: Creating symlink..."
            echo "----------------------------------------"
            echo "ğŸ”— Creating symlink: $(pwd)/app.jar -> $(pwd)/$latest_jar"
            ln -sf "$(pwd)/$latest_jar" "$(pwd)/app.jar"
            ls -la app.jar
            
            echo ""
            echo "ğŸ” STEP 4: Starting Notification service..."
            echo "----------------------------------------"
            echo "ğŸš€ Command: java -jar $(pwd)/app.jar --spring.profiles.active=dispatcher"
            echo "ğŸ“ Log file: $(pwd)/app.log"
            
            # Clear previous log
            > app.log
            
            # Start the application
            nohup java -jar "$(pwd)/app.jar" --spring.profiles.active=dispatcher > app.log 2>&1 &
            app_pid=$!
            echo "ğŸ†” Started with PID: $app_pid"
            
            echo ""
            echo "ğŸ” STEP 5: Monitoring startup..."
            echo "----------------------------------------"
            echo "â³ Waiting for application to start (monitoring for 30 seconds)..."
            
            for i in {1..30}; do
              echo "â±ï¸  Checking startup progress ($i/30)..."
            
              # Check if process is still running
              if ! kill -0 $app_pid 2>/dev/null; then
                echo "âŒ Process died during startup!"
                echo "ğŸ“‹ Last 50 lines of log:"
                tail -n 50 app.log
                exit 1
              fi
            
              # Check for startup indicators in log
              if grep -q "Started.*Application" app.log 2>/dev/null; then
                echo "âœ… Application started successfully!"
                break
              elif grep -q "APPLICATION FAILED TO START" app.log 2>/dev/null; then
                echo "âŒ Application failed to start!"
                echo "ğŸ“‹ Error logs:"
                tail -n 30 app.log
                exit 1
              elif grep -q "Tomcat started on port" app.log 2>/dev/null; then
                echo "âœ… Tomcat server started!"
                break
              fi
            
              sleep 1
            done
            
            echo ""
            echo "ğŸ” STEP 6: Final verification..."
            echo "----------------------------------------"
            
            # Final process check
            if pgrep -f "java -jar.*$(pwd)/app.jar" > /dev/null; then
              final_pid=$(pgrep -f "java -jar.*$(pwd)/app.jar")
              echo "âœ… Notification service is running (PID: $final_pid)"
            
              # Show memory usage
              echo "ğŸ’¾ Memory usage:"
              ps -p $final_pid -o pid,ppid,pcpu,pmem,cmd --no-headers || true
            
              # Show recent log entries
              echo ""
              echo "ğŸ“‹ Recent log entries (last 10 lines):"
              tail -n 10 app.log
            
            else
              echo "âŒ DEPLOYMENT FAILED: Notification service is not running"
              echo "ğŸ“‹ Full log output:"
              cat app.log
              exit 1
            fi
            
            echo ""
            echo "========================================="
            echo "âœ… NOTIFICATION SERVICE DEPLOYED SUCCESSFULLY"
            echo "ğŸ“ Full logs available at: $(pwd)/app.log"
            echo "ğŸ†” Process ID: $(pgrep -f "java -jar.*$(pwd)/app.jar")"
            echo "ğŸ“… Completion Time: $(date)"
            echo "========================================="

      # ---------- Build blog_backend ----------
      - name: Build blog_backend
        working-directory: ./blog_backend
        run: mvn clean package -DskipTests

      # ---------- Upload blog_backend JAR ----------
      - name: Upload blog_backend JAR to Oracle Linux
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          port: 50022
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "blog_backend/target/*.jar"
          target: "~/blog_backend"
          strip_components: 2  # Remove blog_backend/target/ prefix
          timeout: 180s              # 3 minutes timeout
          command_timeout: 300s      # 5 minutes command timeout
          debug: true                # Enable debug mode
          overwrite: true            # Overwrite existing files

      # ---------- Restart blog_backend Service ----------
      - name: Restart blog_backend Java App
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          port: 50022
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "========================================="
            echo "ğŸš€ BLOG BACKEND SERVICE DEPLOYMENT START"
            echo "========================================="
            echo "ğŸ“… Deployment Time: $(date)"
            echo "ğŸ“‚ Working Directory: $(pwd)"
            
            cd ~/blog_backend
            echo "ğŸ“ Current directory: $(pwd)"
            
            echo ""
            echo "ğŸ” STEP 1: Stopping existing blog_backend service..."
            echo "----------------------------------------"
            existing_pids=$(pgrep -f "java -jar .*$(pwd)" || true)
            if [ -n "$existing_pids" ]; then
              echo "Found existing processes: $existing_pids"
              echo "$existing_pids" | while read pid; do
                echo "ğŸ›‘ Stopping process $pid..."
                kill -15 "$pid" 2>/dev/null || kill -9 "$pid" 2>/dev/null
                sleep 2
                if kill -0 "$pid" 2>/dev/null; then
                  echo "âŒ Process $pid still running, force killing..."
                  kill -9 "$pid" 2>/dev/null || true
                else
                  echo "âœ… Process $pid stopped successfully"
                fi
              done
              echo "â³ Waiting 3 seconds for cleanup..."
              sleep 3
            else
              echo "â„¹ï¸  No existing blog_backend processes found"
            fi
            
            echo ""
            echo "ğŸ” STEP 2: Locating JAR files..."
            echo "----------------------------------------"
            echo "ğŸ“‹ Available JAR files:"
            ls -la *.jar 2>/dev/null || echo "âŒ No JAR files found"
            
            latest_jar=$(ls -t *.jar 2>/dev/null | head -n 1)
            if [ -z "$latest_jar" ]; then
              echo "âŒ ERROR: No JAR file found in $(pwd)"
              echo "ğŸ“‚ Directory contents:"
              ls -la
              exit 1
            fi
            
            echo "ğŸ¯ Selected JAR: $latest_jar"
            echo "ğŸ“Š JAR file info:"
            ls -lh "$latest_jar"
            
            echo ""
            echo "ğŸ” STEP 3: Creating symlink..."
            echo "----------------------------------------"
            echo "ğŸ”— Creating symlink: $(pwd)/app.jar -> $(pwd)/$latest_jar"
            ln -sf "$(pwd)/$latest_jar" "$(pwd)/app.jar"
            ls -la app.jar
            
            echo ""
            echo "ğŸ” STEP 4: Starting blog_backend service..."
            echo "----------------------------------------"
            echo "ğŸš€ Command: java -jar $(pwd)/app.jar"
            echo "ğŸ“ Log file: $(pwd)/app.log"
            
            # Clear previous log
            > app.log
            
            # Start the application
            nohup java -jar "$(pwd)/app.jar" > app.log 2>&1 &
            app_pid=$!
            echo "ğŸ†” Started with PID: $app_pid"
            
            echo ""
            echo "ğŸ” STEP 5: Monitoring startup..."
            echo "----------------------------------------"
            echo "â³ Waiting for application to start (monitoring for 30 seconds)..."
            
            for i in {1..30}; do
              echo "â±ï¸  Checking startup progress ($i/30)..."
            
              # Check if process is still running
              if ! kill -0 $app_pid 2>/dev/null; then
                echo "âŒ Process died during startup!"
                echo "ğŸ“‹ Last 50 lines of log:"
                tail -n 50 app.log
                exit 1
              fi
            
              # Check for startup indicators in log
              if grep -q "Started.*Application" app.log 2>/dev/null; then
                echo "âœ… Application started successfully!"
                break
              elif grep -q "APPLICATION FAILED TO START" app.log 2>/dev/null; then
                echo "âŒ Application failed to start!"
                echo "ğŸ“‹ Error logs:"
                tail -n 30 app.log
                exit 1
              elif grep -q "Tomcat started on port" app.log 2>/dev/null; then
                echo "âœ… Tomcat server started!"
                break
              fi
            
              sleep 1
            done
            
            echo ""
            echo "ğŸ” STEP 6: Final verification..."
            echo "----------------------------------------"
            
            # Final process check
            if pgrep -f "java -jar.*$(pwd)/app.jar" > /dev/null; then
              final_pid=$(pgrep -f "java -jar.*$(pwd)/app.jar")
              echo "âœ… blog_backend service is running (PID: $final_pid)"
            
              # Show memory usage
              echo "ğŸ’¾ Memory usage:"
              ps -p $final_pid -o pid,ppid,pcpu,pmem,cmd --no-headers || true
            
              # Show recent log entries
              echo ""
              echo "ğŸ“‹ Recent log entries (last 10 lines):"
              tail -n 10 app.log
            
            else
              echo "âŒ DEPLOYMENT FAILED: blog_backend service is not running"
              echo "ğŸ“‹ Full log output:"
              cat app.log
              exit 1
            fi
            
            echo ""
            echo "========================================="
            echo "âœ… BLOG BACKEND SERVICE DEPLOYED SUCCESSFULLY"
            echo "ğŸ“ Full logs available at: $(pwd)/app.log"
            echo "ğŸ†” Process ID: $(pgrep -f "java -jar.*$(pwd)/app.jar")"
            echo "ğŸ“… Completion Time: $(date)"
            echo "========================================="
